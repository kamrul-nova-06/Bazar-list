<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∞‡¶∏‡¶ø‡¶¶</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f3f4f6;
      font-family: 'Noto Sans Bengali', sans-serif, sans-serif;
    }
    /* A4 paper size styling for receipt container */
    #receiptArea {
      background: white;
      width: 210mm;  /* A4 width */
      min-height: 297mm; /* A4 height */
      margin: 10px auto;
      padding: 30px 40px;
      box-shadow: 0 0 12px rgba(0,0,0,0.15);
      border-radius: 8px;
      box-sizing: border-box;
      color: #1f2937;
      user-select: none;
    }
    /* Table styling */
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      font-size: 16px;
    }
    thead th {
      border-bottom: 2px solid #2563eb;
      background: #eff6ff;
      color: #2563eb;
    }
    /* Full row color for product */
    tbody tr {
      transition: background-color 0.3s ease;
      cursor: pointer;
    }
    tbody tr:hover {
      filter: brightness(95%);
    }
    /* Buttons inside rows */
    .btn-edit, .btn-delete {
      background-color: transparent;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    .btn-edit:hover {
      background-color: #dbeafe;
      color: #2563eb;
    }
    .btn-delete:hover {
      background-color: #fee2e2;
      color: #dc2626;
    }
    /* Color selection presets */
    .color-picker-preset {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }
    .color-preset {
      width: 30px;
      height: 30px;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s ease;
    }
    .color-preset.selected {
      border-color: #2563eb;
    }
    /* Responsive */
    @media (max-width: 768px) {
      #receiptArea {
        width: 95vw;
        min-height: auto;
        padding: 20px;
      }
      th, td {
        font-size: 14px;
        padding: 10px 8px;
      }
    }
    /* Chart area */
    #chartContainer {
      max-width: 700px;
      margin: 30px auto 60px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
      padding: 20px;
    }
  </style>
</head>
<body>

<div class="max-w-screen-lg mx-auto p-6">
  <h1 class="text-center text-4xl font-extrabold mb-6 text-blue-600">‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∞‡¶∏‡¶ø‡¶¶</h1>

  <!-- Input Section -->
  <div class="bg-white p-6 rounded-lg shadow-md mb-8">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
      <input id="itemName" type="text" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="border rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
      <input id="itemQty" type="text" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" class="border rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
      <input id="itemPrice" type="number" placeholder="‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥)" class="border rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
      <div>
        <div class="mb-2 font-semibold">‡¶∞‡¶Ç ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>
        <div class="color-picker-preset" id="colorPresets">
          <!-- Preset colors will be inserted here dynamically -->
        </div>
      </div>
    </div>
    <div class="flex space-x-4">
      <button onclick="addItem()" class="bg-blue-600 text-white rounded px-6 py-2 hover:bg-blue-700 transition">‚ûï ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      <button onclick="resetList()" class="bg-red-600 text-white rounded px-6 py-2 hover:bg-red-700 transition">‚ôªÔ∏è ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
  </div>

  <!-- Search Box -->
  <input id="searchBox" type="text" oninput="filterList()" placeholder="üîç ‡¶™‡¶£‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®" class="w-full border rounded px-4 py-2 mb-6 focus:outline-none focus:ring-2 focus:ring-blue-400" />

  <!-- Receipt Display -->
  <section id="receiptArea" aria-label="‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶∞‡¶∏‡¶ø‡¶¶">
    <header class="flex justify-between mb-6">
      <div class="text-lg font-semibold">‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞: <span id="receiptNumber">0001</span></div>
      <div class="text-lg font-semibold">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: <span id="receiptDate"></span></div>
    </header>

    <table aria-describedby="receiptTable" role="table" class="w-full">
      <thead>
        <tr>
          <th scope="col">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
          <th scope="col">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
          <th scope="col">‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥)</th>
          <th scope="col" class="text-center">‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</th>
        </tr>
      </thead>
      <tbody id="receiptList">
        <!-- Dynamic rows here -->
      </tbody>
    </table>

    <div class="text-right font-bold text-xl mt-6">‡¶Æ‡ßã‡¶ü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø: <span id="totalPrice">‡ß≥0</span></div>

    <textarea id="noteField" placeholder="‚úçÔ∏è ‡¶®‡ßã‡¶ü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="w-full mt-6 p-4 border rounded resize-none" rows="3"></textarea>

    <footer class="text-right text-gray-400 mt-8 text-sm select-none">¬© Kamrul Islam Sohan</footer>
  </section>

  <!-- Chart Section -->
  <section id="chartContainer" aria-label="‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü">
    <canvas id="priceChart" aria-describedby="priceChartDescription"></canvas>
    <p id="priceChartDescription" class="sr-only">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶¶‡¶æ‡¶Æ ‡¶¨‡¶æ‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</p>
  </section>

  <!-- Download Buttons -->
  <div class="flex justify-center space-x-6 mt-8">
    <button onclick="downloadPNG()" class="bg-green-600 hover:bg-green-700 text-white font-semibold rounded px-8 py-3 transition">üì∏ PNG ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
    <button onclick="downloadPDF()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded px-8 py-3 transition">üìÑ PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
  </div>
</div>

<script>
  // Color presets array (persistent selection)
  const colorPresets = [
    '#60a5fa', // blue-400
    '#f87171', // red-400
    '#34d399', // green-400
    '#fbbf24', // yellow-400
    '#a78bfa', // purple-400
    '#f472b6', // pink-400
    '#facc15', // amber-400
    '#38bdf8', // sky-400
    '#a3e635', // lime-400
    '#f97316'  // orange-500
  ];
  
  let selectedColor = colorPresets[0];
  let list = [];
  let receiptNumber = 1;

  // Insert color presets buttons
  const colorContainer = document.getElementById('colorPresets');
  colorPresets.forEach((color, i) => {
    const btn = document.createElement('button');
    btn.classList.add('color-preset');
    if(i === 0) btn.classList.add('selected');
    btn.style.backgroundColor = color;
    btn.title = `‡¶∞‡¶Ç ${i + 1}`;
    btn.addEventListener('click', () => {
      selectedColor = color;
      document.querySelectorAll('.color-preset').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    });
    colorContainer.appendChild(btn);
  });

  // Update date
  function updateDate() {
    const now = new Date();
    document.getElementById('receiptDate').innerText = now.toLocaleDateString('bn-BD', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  }

  // Render receipt list
  function renderList(filteredList = list) {
    const tbody = document.getElementById('receiptList');
    tbody.innerHTML = '';
    let total = 0;

    filteredList.forEach((item, idx) => {
      const tr = document.createElement('tr');
      tr.style.backgroundColor = item.color;
      tr.style.color = getContrastYIQ(item.color);
      tr.setAttribute('data-index', idx);

      tr.innerHTML = `
        <td>${item.name || '-'}</td>
        <td>${item.qty || '-'}</td>
        <td>${item.price || '-'}</td>
        <td class="text-center">
          <button class="btn-edit" title="‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ" onclick="editItem(${idx})">&#9998;</button>
          <button class="btn-delete" title="‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®" onclick="deleteItem(${idx})">&#10060;</button>
        </td>
      `;

      tbody.appendChild(tr);

      // Total price calculation
      let priceNum = parseFloat(item.price);
      if (!isNaN(priceNum)) total += priceNum;
    });

    document.getElementById('totalPrice').innerText = `‡ß≥${total.toFixed(2)}`;
    updateChart(filteredList);
  }

  // Add item
  function addItem() {
    const name = document.getElementById('itemName').value.trim();
    const qty = document.getElementById('itemQty').value.trim();
    const price = document.getElementById('itemPrice').value.trim();

    if (!name) {
      alert('‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!');
      return;
    }

    list.push({ name, qty: qty || '-', price: price || '-', color: selectedColor });

    clearInputs();
    renderList();
  }

  // Clear input fields
  function clearInputs() {
    document.getElementById('itemName').value = '';
    document.getElementById('itemQty').value = '';
    document.getElementById('itemPrice').value = '';
  }

  // Edit item
  function editItem(idx) {
    const item = list[idx];
    const newName = prompt('‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®:', item.name);
    if (newName === null) return; // cancel pressed
    const newQty = prompt('‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®:', item.qty);
    if (newQty === null) return;
    const newPrice = prompt('‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥) ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®:', item.price);
    if (newPrice === null) return;

    list[idx] = {
      name: newName.trim() || '-',
      qty: newQty.trim() || '-',
      price: newPrice.trim() || '-',
      color: item.color
    };

    renderList();
  }

  // Delete item
  function deleteItem(idx) {
    if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
      list.splice(idx, 1);
      renderList();
    }
  }

  // Filter/Search
  function filterList() {
    const searchTerm = document.getElementById('searchBox').value.trim().toLowerCase();
    if (!searchTerm) {
      renderList();
      return;
    }
    const filtered = list.filter(item => item.name.toLowerCase().includes(searchTerm));
    renderList(filtered);
  }

  // Reset
  function resetList() {
    if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
      list = [];
      renderList();
      document.getElementById('noteField').value = '';
    }
  }

  // Get contrasting text color based on background
  function getContrastYIQ(hexcolor){
    hexcolor = hexcolor.replace('#', '');
    const r = parseInt(hexcolor.substr(0,2),16);
    const g = parseInt(hexcolor.substr(2,2),16);
    const b = parseInt(hexcolor.substr(4,2),16);
    const yiq = ((r*299)+(g*587)+(b*114))/1000;
    return (yiq >= 128) ? '#000' : '#fff';
  }

  // Chart.js instance
  let chartInstance = null;

  // Update Chart
  function updateChart(dataList = list) {
    const ctx = document.getElementById('priceChart').getContext('2d');
    if(chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: dataList.map(i => i.name),
        datasets: [{
          label: '‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥)',
          data: dataList.map(i => parseFloat(i.price) || 0),
          backgroundColor: dataList.map(i => i.color),
          borderWidth: 1,
          borderColor: '#444'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true },
          title: {
            display: true,
            text: '‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶¶‡¶æ‡¶Æ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£'
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  // Download PNG (receipt + chart)
  async function downloadPNG() {
    const receipt = document.getElementById('receiptArea');
    const chart = document.getElementById('chartContainer');
    // Temporarily combine receipt and chart for screenshot
    const container = document.createElement('div');
    container.style.background = 'white';
    container.style.padding = '20px';
    container.style.width = receipt.offsetWidth + 'px';
    container.style.boxSizing = 'border-box';
    container.appendChild(receipt.cloneNode(true));
    container.appendChild(chart.cloneNode(true));

    document.body.appendChild(container);

    const canvas = await html2canvas(container, { scale: 2, useCORS: true });
    const link = document.createElement('a');
    link.download = 'bazar_receipt.png';
    link.href = canvas.toDataURL();
    link.click();

    document.body.removeChild(container);
  }

  // Download PDF (A4) with receipt + chart
  async function downloadPDF() {
    const receipt = document.getElementById('receiptArea');
    const chart = document.getElementById('chartContainer');

    // We will use html2canvas for both, then add images to jsPDF
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    let yOffset = 10;

    // Render receipt
    const receiptCanvas = await html2canvas(receipt, { scale: 2, useCORS: true });
    const receiptImg = receiptCanvas.toDataURL('image/png');
    const receiptHeight = (receiptCanvas.height * pdfWidth) / receiptCanvas.width;
    pdf.addImage(receiptImg, 'PNG', 0, yOffset, pdfWidth, receiptHeight);
    yOffset += receiptHeight + 10;

    // Render chart
    const chartCanvas = await html2canvas(chart, { scale: 2, useCORS: true });
    const chartImg = chartCanvas.toDataURL('image/png');
    const chartHeight = (chartCanvas.height * pdfWidth) / chartCanvas.width;

    // If chart won't fit on this page, add new page
    if (yOffset + chartHeight > pdf.internal.pageSize.getHeight()) {
      pdf.addPage();
      yOffset = 10;
    }
    pdf.addImage(chartImg, 'PNG', 0, yOffset, pdfWidth, chartHeight);

    pdf.save('bazar_receipt.pdf');
  }

  // Initialize date and receipt number
  function initialize() {
    updateDate();
    document.getElementById('receiptNumber').innerText = receiptNumber.toString().padStart(4, '0');
  }

  // Initialize on load
  window.onload = () => {
    initialize();
    renderList();
  };
</script>

</body>
</html>
